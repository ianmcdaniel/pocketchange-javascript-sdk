//  PocketChange JavaScript SDK
//  Copyright 2013, Ian McDaniel, Pocket Change Inc.
//  For all api documentation:
//  http://pocketchange.com/documentation

(function(){"use strict";this.PocketChange=function(){function t(){return t}return t.version="0.1.5",t.initialize=function(e,i){if(!e)throw Error("Pocket Change Javascript SDK requires an API Key");return this.client=new t.Client(e,i),this},t.isInitialized=function(){return!!this.client},t.grantReward=function(t,e){this.client.grantReward(t,e)},t.openShop=function(){this.client.openShop()},t}.call(this)}).call(this),function(t){t.Util={extend:function(t,e){for(var i in e)t[i]=e[i];return t},bind:function(t,e){return function(){return t.apply(e,arguments)}},serialize:function(t){var e=[];for(var i in t)e.push(encodeURIComponent(i)+"="+encodeURIComponent(t[i]));return e.join("&")},deserialize:function(t){for(var e,i={},n=t.split("&"),s=0;n.length>s;s++)e=n[s].split("=",2),e&&e[0]&&(i[decodeURIComponent(e[0])]=decodeURIComponent(e[1]));return i},uuid:function(){return(0|65536*(1+Math.random())).toString(16).substring(1)},indexOf:function(t,e){for(var i=0;t.length>i;i++)return t[i]===e?i:-1},storage:function(t,e){try{return e?(localStorage.setItem(t,e),!0):localStorage.getItem(t)}catch(i){return!1}}}}.call(this,PocketChange),function(t){var e=t.Util.extend,i=t.Util.indexOf;t.Events={on:function(t,e){this.events=this.events||{},this.events[t]=this.events[t]||[],this.events[t].push(e)},off:function(t,e){this.events=this.events||{},t in this.events!=!1&&(e?this.events[t].splice(i(this.events[t],e),1):this.events[t]=[])},trigger:function(t){if(this.events=this.events||{},t in this.events!=!1)for(var e=0;this.events[t].length>e;e++)this.events[t][e].apply(this,Array.prototype.slice.call(arguments,1))}},e(t,t.Events)}.call(this,PocketChange),function(t){var e=t.Util,i=e.extend,n=e.bind,s=e.serialize,r=e.deserialize,o=e.uuid;t.Request={callbacks:{},popup:function(e,n,r){this.registerXDHandler();var o=e||{},a=window.screenX||window.screenLeft,c=window.screenY||window.screenTop,h=window.outerWidth||document.documentElement.clientWidth,l=window.outerHeight||document.documentElement.clientHeight-22,d=o.width||600,u=o.height||400,p=parseInt(a+(h-d)/2,10),f=parseInt(c+(l-u)/2.5,10),g="width="+d+",height="+u+",left="+p+",top="+f,m=this.getCallbackId(),v=i(o.data||{},{callback:m,origin:this.getOrigin()}),w=o.url+(o.url.indexOf("?")>-1?"&":"?")+s(v),y=window.open(w,o.name||m,g);return this.callbacks[m]=function(e,i){i.error&&r&&r(i),n&&n(e,i,y),delete t.Request.callbacks[m]},y},iframe:function(e,n,r){this.registerXDHandler();var o=e||{},a=document.createElement("iframe"),c=this.getCallbackId(),h=i(o.data||{},{callback:c,origin:this.getOrigin()}),l=o.url+(o.url.indexOf("?")>-1?"&":"?")+s(h);if(this.callbacks[c]=function(e,i){i.error&&r&&r(i),n&&n(e,i),delete t.Request.callbacks[c]},a.setAttribute("frameBorder","0"),a.setAttribute("allowtransparency","true"),document.body.appendChild(a),a.contentWindow.name=c,o.method&&o.method.match(/post/i)){var d;d=document.createElement("form"),d.setAttribute("action",l),d.setAttribute("method","post"),d.setAttribute("target",c),document.body.appendChild(d),d.submit(),d.parentNode.removeChild(d)}else a.setAttribute("src",l);for(var u in o.style)a.style[u]=o.style[u];return a},proxy:function(e,n,r){var o=e||{},a=this.getCallbackId(),c=i(o.data||{},{callback:a,origin:this.getOrigin()}),h=o.url+(o.url.indexOf("?")>-1?"&":"?")+s(c);this.callbacks[a]=function(e,i){i.error&&r&&r(i),n&&n(e,i),delete t.Request.callbacks[a]},this.hidden({url:o.proxy_url,data:i({url:h,method:o.method},o.proxy_data||{})})},hidden:function(t,e,n){var s,r=t||{},o=function(t,i){e&&e(t,i),s.parentNode.removeChild(s)};r.style=r.style||{},r.style=i(r.style,{display:"none",height:0,width:0}),s=this.iframe(r,o,n)},registerXDHandler:function(){this._xdregistered||(window.addEventListener?window.addEventListener("message",n(this.onMessage,this),!1):window.attachEvent("onmessage",n(this.onMessage,this)),this._xdregistered=!0)},onMessage:function(t){var e={};if(t.data&&"string"==typeof t.data&&(e=r(t.data)),e.callback){var i=this.callbacks[e.callback];if(i){var n=e.message&&e.message.match(/\=/g)?r(e.message):e.message;i(n,e),delete this.callbacks[e.callback]}}},getCallbackId:function(){return"pc"+o()},getOrigin:function(){return window.location.protocol+"//"+window.location.host}}}.call(this,PocketChange),function(t){var e=t.Request,i=t.Util.bind,n=t.Util.extend;t.RewardView=function(t){t&&t.dialog_url&&(this.url=t.dialog_url,this.optIn=t.optIn)},t.RewardView.prototype={frame:null,style:{"background-color":"transparent",border:"0px none transparent",overflow:"hidden",visibility:"visible",margin:"0px",padding:"0px",position:"fixed","z-index":"9999",display:"none"},overlay_style:{left:"0px",top:"0px",width:"100%",height:"100%"},standard_style:{right:"0px",bottom:"0px",width:"335px",height:"165px"},open:function(){if(this.url){var t=this.optIn?this.overlay_style:this.standard_style,s=this.frame=e.iframe({url:this.url,style:n(n({},this.style),t)},i(this.handleNotificationResponse,this));s.onload=function(){this.style.display="block"}}},close:function(){this.frame&&(this.frame.parentNode.removeChild(this.frame),this.frame=null)},handleNotificationResponse:function(t,e){"close"==e.message&&this.close()}}}.call(this,PocketChange),function(t){var e=t.Util.extend,i=t.Util.bind,n=t.Util.indexOf;t.Achievements=function(t){this.rewardTypes=t||[]},t.Achievements.prototype={ready:!1,timeout:20,initialize:function(){},doReadyCheck:function(){var t=0,e=100,n=i(function(){if(t+=e,!this.ready)if(this.isReady())this.onReady(),this.ready=!0;else if(1e3*this.timeout>t)return setTimeout(n,e),void 0},this);n()},isReady:function(){},onReady:function(){},listeningFor:function(t){return-1!=n(this.rewardTypes,t)||-1!=n(this.rewardTypes,"*")},triggerAchievement:function(e){t.Achievements.trigger("achievement",e)}},t.Achievements.platforms={},t.Achievements.define=function(i,n){n=n||{},this.platforms[i]=function(){t.Achievements.apply(this,arguments),this.initialize.apply(this,arguments)},this.platforms[i].prototype=new t.Achievements,this.platforms[i].prototype.constructor=this.platforms[i],e(this.platforms[i].prototype,n)},t.Achievements.register=function(t){if(t){var e,i=t.length,n={};for(e=0;i>e;e++){var s=t[e].split(":");n[s[0]]=n[s[0]]||[],n[s[0]].push(s[1]||"*")}for(var r in n)this.platforms[r]&&new this.platforms[r](n[r])}},e(t.Achievements,t.Events)}.call(this,PocketChange),function(t){var e=t.Util,i=e.extend,n=e.bind,s=e.storage,r=t.Request,o=500,a=700;t.Client=function(e,i){return arguments.callee._instance?arguments.callee._instance:(arguments.callee._instance=this,this.options=i||{},this.apiKey=e,this.device_user_key=s("pc_dk"),this.achievements=t.Achievements,this.achievements.on("achievement",n(this.grantReward,this)),this.options.achievements&&this.achievements.register(this.options.achievements),this.grantDaily(),void 0)},t.Client.prototype={apiVersion:2,serverURL:{production:"http://pocketchange.com",sandbox:"http://sandbox.pocketchange.com"},grantReward:function(t,e,i){var s=this.getApiParameters();s.rewards='{"'+t+'":'+(""+(e||1))+"}";var o=this.device_user_key?{device_user_key:this.device_user_key}:{};r.proxy({proxy_url:this.getPath("/api_proxy"),proxy_data:o,method:"post",url:this.getApiPath("/rewards"),data:s},n(function(t,e){this.setDeviceUserKey(e.deviceUserKey),this.displayReward(t),i&&i(t)},this),function(){})},setDeviceUserKey:function(t){t&&(this.device_user_key=t||null,s("pc_dk",this.device_user_key))},grantDaily:function(){var t=s("pc_la")||0,e=(new Date).getTime(),i=864e5;e>parseInt(t,10)+i&&this.grantReward("daily")},displayReward:function(e){var i=e&&e.dialog_url;i&&(("ok"==e["rewards[daily]"]||1==e.optIn)&&s("pc_la",(new Date).getTime()),this.rewardView&&(this.rewardView.close(),this.rewardView=null),this.rewardView=new t.RewardView(e),this.rewardView.open())},openShop:function(){this.options.testMode?"sandbox":"production",r.popup({name:"store_window",data:this.getApiParameters(),url:this.getPath("/store"),width:o,height:a})},getPath:function(t){var e=this.options.testMode?"sandbox":"production",i=this.options.host||this.serverURL[e];return i+"/"+t.replace(/^\//,"")},getApiPath:function(t){return this.getPath("/v"+this.apiVersion+"/"+t.replace(/^\//,""))},getApiParameters:function(){var t={api_key:this.apiKey,type:"pc"};return t}},i(t.Client.prototype,t.Events)}.call(this,PocketChange),function(t){var e=t.Util.bind;t.Achievements.define("facebook",{initialize:function(){this.doReadyCheck()},isReady:function(){return!!(window.FB&&FB.Event&&FB.Event.subscribe)},onReady:function(){this.captureLikes(),this.captureComments()},captureLikes:function(){this.listeningFor("like")&&FB.Event.subscribe("edge.create",e(function(){this.triggerAchievement("facebook-like")},this))},captureComments:function(){this.listeningFor("comment")&&FB.Event.subscribe("comment.create",e(function(){this.triggerAchievement("facebook-comment")},this))}})}.call(this,PocketChange),function(t){var e=t.Util.bind;t.Achievements.define("twitter",{initialize:function(){this.doReadyCheck()},isReady:function(){return!!(window.twttr&&twttr.ready&&twttr.events&&twttr.events.bind)},onReady:function(){this.captureTweets(),this.captureFollows()},captureTweets:function(){this.listeningFor("post")&&twttr.ready(e(function(t){t.events.bind("tweet",e(function(){this.triggerAchievement("twitter-post")},this))},this))},captureFollows:function(){this.listeningFor("follow")&&twttr.ready(e(function(t){t.events.bind("follow",e(function(){this.triggerAchievement("twitter-follow")},this))},this))}})}.call(this,PocketChange);